<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Liturgical Display</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="">
  <div id="title" class="block text-5xl text-black m-4 mr-10 tracking-wide text-right" style="font-family: 'Crimson Pro', serif;"></div>
  <div id="text" class="text-4xl m-10 md:text-8xl leading-tight md:leading-tight text-black px-4" style="font-family: 'Crimson Pro', serif;">
    Welcome
  </div>

  <script>
    
    function appendLog(...args) {
      console.log(...args);
    }

    let ws;
    let reconnectInterval = 1000; // Start with 1 second
    const maxReconnectInterval = 30000; // Max 30 seconds

    function connect() {
      ws = new WebSocket(`ws://${location.host}/ws`);
      
      ws.onopen = () => {
        appendLog("[display] ws connected");
        reconnectInterval = 1000; // Reset reconnect interval on successful connection
      };
      
      ws.onclose = () => {
        appendLog("[display] ws closed, reconnecting...");
        setTimeout(() => {
          reconnectInterval = Math.min(reconnectInterval * 2, maxReconnectInterval);
          connect();
        }, reconnectInterval);
      };
      
      ws.onerror = (e) => {
        appendLog("[display] ws error", e);
        ws.close(); // This will trigger onclose which handles reconnection
      };
      
      ws.onmessage = (ev) => {
        appendLog("[display] recv", ev.data);
        const m = JSON.parse(ev.data);
        if (m.cmd === "set") {
          if (m.title !== undefined) document.getElementById('title').textContent = m.title;
          if (m.text  !== undefined) document.getElementById('text').textContent  = m.text;
        } else if (m.cmd === "clear") {
          document.getElementById('text').textContent = "";
        }
      };
    }

    // Start initial connection
    connect();
  </script>
</body>
</html>